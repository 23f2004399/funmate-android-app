rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAccountOwner(accountId) {
      return isAuthenticated() && request.auth.uid == accountId;
    }
    
    // 1. ACCOUNTS - Only user can read their own account
    match /accounts/{accountId} {
      allow read: if isAccountOwner(accountId);
      allow create: if isAccountOwner(accountId);
      allow update: if isAccountOwner(accountId);
      allow delete: if false; // Never delete accounts
    }
    
    // 2. MERCHANT VERIFICATION - Merchants can create/update their own verification
    match /merchantVerification/{accountId} {
      allow read: if isAccountOwner(accountId);
      allow create: if isAccountOwner(accountId);
      allow update: if isAccountOwner(accountId);
      allow delete: if false; // Only admins can delete
    }
    
    // 3. USERS - Public profiles (readable by all authenticated users)
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if false;
    }
    
    // 4. VERIFICATIONS - Users can create their own verifications
    match /verifications/{verificationId} {
      allow read: if isAuthenticated() && 
                     resource.data.accountId == request.auth.uid;
      allow create: if isAuthenticated() && 
                       request.resource.data.accountId == request.auth.uid;
      allow update, delete: if false; // Only Cloud Functions can update/delete
    }
    
    // 5. BANK ACCOUNTS - Private, user can only access their own
    match /bankAccounts/{accountId} {
      allow read: if isAccountOwner(accountId);
      allow create: if isAccountOwner(accountId);
      allow update: if isAccountOwner(accountId);
      allow delete: if false;
    }
    
    // 6. SWIPES - User can create their own swipes, target can update actedOnByTarget
    match /swipes/{swipeId} {
      allow read: if isAuthenticated() && 
                     (resource.data.fromUserId == request.auth.uid || 
                      resource.data.toUserId == request.auth.uid);
      allow create: if isAuthenticated() && 
                       request.resource.data.fromUserId == request.auth.uid;
      // Allow target user to update actedOnByTarget field only
      allow update: if isAuthenticated() && 
                       resource.data.toUserId == request.auth.uid &&
                       request.resource.data.actedOnByTarget == true &&
                       request.resource.data.fromUserId == resource.data.fromUserId &&
                       request.resource.data.toUserId == resource.data.toUserId &&
                       request.resource.data.action == resource.data.action;
      allow delete: if false;
    }
    
    // 7. MATCHES - Both users can read/list their own matches, participants can create/update blockedBy
    match /matches/{matchId} {
      // Allow reading individual match docs where user is a participant
      allow get: if isAuthenticated() && 
                    (resource.data.userA == request.auth.uid || 
                     resource.data.userB == request.auth.uid) &&
                    // Hide if blocked by other user
                    (resource.data.blockedBy == null || 
                     resource.data.blockedBy == request.auth.uid);
      // Allow listing/querying matches where user is a participant (without blockedBy check for query compatibility)
      allow list: if isAuthenticated() && 
                     (resource.data.userA == request.auth.uid || 
                      resource.data.userB == request.auth.uid);
      allow create: if isAuthenticated() && 
                       (request.resource.data.userA == request.auth.uid || 
                        request.resource.data.userB == request.auth.uid);
      // Allow updating blockedBy field only
      allow update: if isAuthenticated() && 
                       (resource.data.userA == request.auth.uid || 
                        resource.data.userB == request.auth.uid) &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['blockedBy']);
      allow delete: if false;
    }
    
    // 8. CHATS - Only participants can access
    match /chats/{chatId} {
      allow read: if isAuthenticated() && 
                     request.auth.uid in resource.data.participants;
      allow create: if isAuthenticated() && 
                       request.auth.uid in request.resource.data.participants;
      allow update: if isAuthenticated() && 
                       request.auth.uid in resource.data.participants &&
                       // Allow updating deletedAt, deletedBy, permanentlyDeleteAt for soft delete
                       (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['deletedAt', 'deletedBy', 'permanentlyDeleteAt', 'lastMessage', 'lastMessageAt', 'isMutual', 'relatedMatchId', 'lastReadBy']) ||
                        // Or allow all fields during regular updates
                        request.resource.data.keys().hasAll(['type', 'participants', 'createdAt']));
      allow delete: if false; // Cloud Functions only for permanent deletion
    }
    
    // 9. MESSAGES - Only chat participants can access
    match /messages/{messageId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Allow sender to update/delete their message
      // Allow any chat participant to update reactions only
      // Allow updating hiddenForUsers during shadow blocking
      allow update: if isAuthenticated() && 
                       (resource.data.senderId == request.auth.uid ||
                        // Allow reactions update by checking only reactions field changes
                        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions'])) ||
                        // Allow hiddenForUsers update during shadow blocking
                        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['hiddenForUsers'])));
      allow delete: if isAuthenticated() && 
                       resource.data.senderId == request.auth.uid;
    }
    
    // 10. GROUPS - Members can read, owner can update
    match /groups/{groupId} {
      allow read: if isAuthenticated() && 
                     request.auth.uid in resource.data.members;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
                       (request.auth.uid == resource.data.ownerId ||
                        request.auth.uid in resource.data.admins);
      allow delete: if isAuthenticated() && 
                       request.auth.uid == resource.data.ownerId;
    }
    
    // 11. EVENTS - Public read, creator can write
    match /events/{eventId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
                       resource.data.hostAccountId == request.auth.uid;
      allow delete: if isAuthenticated() && 
                       resource.data.hostAccountId == request.auth.uid;
    }
    
    // 12. EVENT BOOKINGS - User can read their own bookings
    match /eventBookings/{bookingId} {
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
      allow delete: if false;
    }
    
    // 13. EVENT VERIFIERS - Only event host can manage
    match /eventVerifiers/{verifierId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only Cloud Functions or admin
    }
    
    // 14. PAYMENTS - User can read their own payments
    match /payments/{paymentId} {
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      allow write: if false; // Only backend writes payments
    }
    
    // 15. LEDGER - Read-only for account owner
    match /ledger/{entryId} {
      allow read: if isAuthenticated() && 
                     resource.data.accountId == request.auth.uid;
      allow write: if false; // Only Cloud Functions
    }
    
    // 16. SETTLEMENTS - Creator can read their own
    match /settlements/{settlementId} {
      allow read: if isAuthenticated() && 
                     resource.data.accountId == request.auth.uid;
      allow write: if false; // Only Cloud Functions
    }
    
    // 17. REFUNDS - User can read their own refunds
    match /refunds/{refundId} {
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }
    
    // 18. CALL LOGS - Participants can read
    match /callLogs/{callId} {
      allow read: if isAuthenticated() && 
                     (resource.data.callerId == request.auth.uid || 
                      resource.data.receiverId == request.auth.uid);
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if false;
    }
    
    // 19. BLOCKED USERS - User can manage their own blocks
    match /blockedUsers/{blockId} {
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || 
                      resource.data.blockedUserId == request.auth.uid);
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
      allow update: if false;
    }
    
    // 20. REPORTS - User can create reports, admins can review
    match /reports/{reportId} {
      allow read: if isAuthenticated() && 
                     resource.data.reporterId == request.auth.uid;
      allow create: if isAuthenticated() && 
                       request.resource.data.reporterId == request.auth.uid &&
                       request.resource.data.status == 'pending';
      allow update, delete: if false; // Only Cloud Functions/admins
    }
    
    // NEW: ACCOUNT SUSPENSIONS - User can read their own, only backend writes
    match /accountSuspensions/{suspensionId} {
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      allow write: if false; // Only Cloud Functions can create/update
    }
    
    // 21. NOTIFICATIONS - User can read their own
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
      allow create, delete: if false; // Only Cloud Functions
    }
    
    // 22. SUBSCRIPTIONS - User can read their own
    match /subscriptions/{subscriptionId} {
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      allow write: if false; // Only backend
    }
    
    // 23. APP CONFIG - Public read, no write
    match /appConfig/{configId} {
      allow read: if true; // Public read for active configs
      allow write: if false; // Only admins via console
    }
  }
}
